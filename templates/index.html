<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VXZZP0WRSC"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-VXZZP0WRSC');
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TalKR</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        font-family: 'Noto Sans KR', sans-serif;
        height: 100%;
        background-color: #f1f1f1;
      }
      .container {
        max-width: 480px;
        margin: 0 auto;
        height: 100%;
        display: flex;
        flex-direction: column;
        background-color: white;
      }
      .header {
        background-color: white;
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
      }
      .header h2 {
        margin: 0;
        font-weight: 700;
      }
      .header h2 span.green {
        color: #4caf50;
      }
      .chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }
      .message {
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        position: relative;
      }
      .user-message {
        align-items: flex-end;
      }
      .bot-message {
        align-items: flex-start;
      }
      .message-bubble {
        max-width: 70%;
        padding: 10px;
        border-radius: 20px;
        position: relative;
        transform: translateZ(0);
        transition: transform 0.3s ease;
      }
      .message-bubble:hover {
        transform: translateZ(10px);
      }
      .user-message .message-bubble {
        background-color: #4caf50;
        color: white;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1), 
                    inset -2px -2px 5px rgba(0, 0, 0, 0.1),
                    inset 2px 2px 5px rgba(255, 255, 255, 0.3);
      }
      .bot-message .message-bubble {
        background-color: #f1f1f1;
        color: black;
        box-shadow: -2px 2px 5px rgba(0, 0, 0, 0.1),
                    inset 2px -2px 5px rgba(0, 0, 0, 0.1),
                    inset -2px 2px 5px rgba(255, 255, 255, 0.3);
      }
      .translation {
        font-size: 0.9em;
        color: #ffffff;
        margin-top: 5px;
        padding: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        display: none;
        max-width: 70%;
        word-wrap: break-word;
      }
      .input-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
        background-color: white;
        border-top: 1px solid #e0e0e0;
      }
      .text-input-container {
        display: flex;
        width: 100%;
        margin-top: 10px;
      }
      #user-input {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 20px;
        background-color: #f1f1f1;
        font-family: 'Noto Sans KR', sans-serif;
      }
      #send-btn {
        background-color: transparent;
        border: none;
        color: #4caf50;
        padding: 10px;
        cursor: pointer;
        font-family: 'Noto Sans KR', sans-serif;
      }
      #voice-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #ff4444;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background-color 0.3s;
        overflow: hidden;
      }
      #voice-btn:hover {
        background-color: #ff6666;
      }
      .mic-icon {
        width: 24px;
        height: 24px;
        transition: transform 0.3s ease;
      }
      #voice-btn.active .mic-icon {
        animation: flipCoin 2s linear infinite;
      }
      #voice-btn svg {
        width: 100%;
        height: 100%;
        fill: white;
      }
      @keyframes flipCoin {
        0% {
          transform: rotateY(0deg);
        }
        50% {
          transform: rotateY(180deg);
        }
        100% {
          transform: rotateY(360deg);
        }
      }
      .translate-btn {
        background-color: transparent;
        border: none;
        color: #4caf50;
        padding: 5px;
        cursor: pointer;
        font-size: 0.8em;
        align-self: flex-start;
        margin-top: 5px;
        font-family: 'Noto Sans KR', sans-serif;
      }
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px;
      }
      .loading-dots {
        display: flex;
      }
      .loading-dots span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #4caf50;
        margin: 0 3px;
        opacity: 0;
        animation: loadingDots 1.4s infinite ease-in-out both;
      }
      .loading-dots span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .loading-dots span:nth-child(2) {
        animation-delay: -0.16s;
      }
      @keyframes loadingDots {
        0%, 80%, 100% { opacity: 0; }
        40% { opacity: 1; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h2>Tal<span class="green">KR</span></h2>
      </div>
      <div id="chat-container" class="chat-container">
        <!-- Chat messages will be added here -->
      </div>
      <div class="input-container">
        <button id="voice-btn">
          <div class="mic-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
            </svg>
          </div>
        </button>
        <div class="text-input-container">
          <input
            type="text"
            id="user-input"
            placeholder="Type your message..."
          />
          <button id="send-btn">Send</button>
        </div>
      </div>
    </div>

    <script>
     document.addEventListener("DOMContentLoaded", function () {
  const chatContainer = document.getElementById("chat-container");
  const userInput = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");
  const voiceBtn = document.getElementById("voice-btn");

  let isRecording = false;
  let mediaRecorder;
  let audioChunks = [];

  function startRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();

        mediaRecorder.addEventListener("dataavailable", event => {
          audioChunks.push(event.data);
        });

        mediaRecorder.addEventListener("stop", () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          sendAudioMessage(audioBlob);
          audioChunks = [];
        });

        isRecording = true;
        voiceBtn.classList.add("active");
      });
  }

  function stopRecording() {
    if (mediaRecorder && isRecording) {
      mediaRecorder.stop();
      isRecording = false;
      voiceBtn.classList.remove("active");
    }
  }

  function sendAudioMessage(audioBlob) {
    const formData = new FormData();
    formData.append("audio", audioBlob, "recording.wav");

    fe      method: "POST",
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        addMessage(data.message, false, data.audio);
      } else {
        addMessage("오류가 발생했습니다. 다시 시도해 주세요.", false);
      }
    })
    .catch(error => {
      console.error("Error:", error);
      addMessage("네트워크 오류가 발생했습니다.", false);
    });
  }

  function addMessage(message, isUser, audioData) {
    // (기존 addMessage 함수 코드)
  }

  function sendMessage(message) {
    if (message) {
      addMessage(message, true);
      userInput.value = "";

      fetch("/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ message: message }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          addMessage(data.message, false, data.audio);
        } else {
          addMessage("오류가 발생했습니다. 다시 시도해 주세요.", false);
        }
      })
      .catch(error => {
        console.error("Error:", error);
        addMessage("네트워크 오류가 발생했습니다.", false);
      });
    }
  }

  sendBtn.addEventListener("click", () => sendMessage(userInput.value.trim()));

  userInput.addEventListener("keypress", function (e) {
    if (e.key === "Enter") {
      sendMessage(userInput.value.trim());
    }
  });
    </script>
  </body>
</html>
